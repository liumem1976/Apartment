## Task B — Domain Model Scan

Scan target: `app/models/domain.py`

Summary of models and notable fields found:

- `Company` : `id`, `code`, `name`, `communities` (Relationship)
- `Community` : `id`, `code`, `name`, `company_id`, `company`, `buildings`
- `Building` : `id`, `code`, `name`, `community_id`, `community`, `units`
- `Unit` : `id`, `unit_no`, `remark`, `building_id`, `building`
- `Tenant` : `id`, `name`, `mobile`, `leases`
- `Lease` : `id`, `unit_id`, `tenant_id`, `start_date`, `end_date`, `rent_amount` (Numeric(18,4) via `sa_column`), `deposit_amount`, `tenant`
- `Meter` : `id`, `unit_id`, `kind`, `slot`
- `MeterReading` : `id`, `meter_id`, `period`, `reading`, `read_at`
- `TariffWater` : `id`, `company_id`, `community_id`, `cold_price`, `hot_price`
- `ChargeItem` : `id`, `code`, `description`
- `Bill` : `id`, `unit_id`, `cycle_start`, `cycle_end`, `status` (stored as Text), plus alignment fields: `company_id`, `community_id`, `total_amount` (Numeric(18,4)), `frozen_snapshot`, `lines` (Relationship)
- `BillLine` : `id`, `bill_id`, `item_code`, `qty`, `unit_price`, `amount`, `charge_code`, `bill` (Relationship)
- `Adjustment` : `id`, `bill_line_id`, `delta`, `reason`
- `User` : `id`, `username`, `password_hash`, `role`
- `AuditLog` : `id`, `table_name` (default ""), `row_id`, `before`, `after`, `actor`, `ip`, `trace_id`, `created_at`
- `AppConfig` : `id`, `key`, `value`
- `ImportBatch` : `id`, `filename`, `kind`, `status`, `created_at`, `started_at`, `finished_at`, `result`, `errors`

Migration coverage (checked `alembic/versions`):

- `0001_create_core_tables.py` : core tables created (base schema)
- `0002_add_bill_fields.py` : adds `bill.company_id`, `bill.community_id`, `bill.total_amount`, `bill.frozen_snapshot`, and `billline.charge_code` (all nullable)
- `0002_add_unit_remark.py` : adds `unit.remark` (nullable)
- `0003_merge_heads.py` : merge-only revision to unify parallel heads

Findings / Notes:

- `Unit.remark` is present in `domain.py` and there is an Alembic migration `0002_add_unit_remark.py` — OK.
- `Bill` alignment fields (`company_id`, `community_id`, `total_amount`, `frozen_snapshot`) are present and covered by `0002_add_bill_fields.py` — OK.
- `BillLine.charge_code` exists in model and in `0002_add_bill_fields.py` — OK.
- `Lease.rent_amount` is mapped to `Numeric(18,4)` via `sa_column` to enforce precision — matches data constraints.
- `AuditLog.table_name` defaulted to empty string to avoid NOT NULL runtime errors — intentional compatibility change.
- Enum `BillStatus` is stored as a `Text` column in `Bill.status`; migrations don't need to change storage but ensure application code uses the Enum — OK.

Risks / Recommendations:

1. Alembic multiple-heads have been resolved via `0003_merge_heads.py`; ensure remote CI uses the merged revision (we stamped locally during earlier steps). Document the stamp procedure in `docs/DEVELOPER_NOTES.md`.
2. Local formatting automation is intermittently blocked by import-time Alembic operations in some tools; CI now runs `ruff/isort/black` to validate formatting. For local auto-fix, run formatters in an isolated process (or set an env var to bypass Alembic import checks) before committing.
3. Add a small developer note describing how to recreate dev DB or run `alembic stamp 0003_merge_heads` if the local DB already contains schema (to avoid `table already exists` errors).
4. If you plan additional schema changes, create separate migration files per logical change and avoid runtime ALTERs in application code.

Next automated steps I will perform (Task B short-run):

1. Run formatters in isolation and commit any formatting fixes.
2. Run `pytest`, fix failures if any, and commit fixes.
3. If I detect model-vs-migration mismatches during the above, generate minimal migration files and commit them.

Report generated by automated scan on: 2026-02-09
