# Pull Request: squash-by-module -> main

**变更概述**
- 将 CSV/Excel 导入迁移为后台批处理（异步/队列），以支持大文件与稳定的超时/重试逻辑。
- 在账单计算中加入“上月欠费”项目以补齐历史账务逻辑。
- 新增 `Payment` 模型与对外 API（创建付款记录、查询、导入），包含对应 Alembic 迁移文件。
- 增加计费导出（CSV / XLSX）功能与相关测试。
- 补齐 CI 流程与依赖声明，增加单元/集成测试框架支持。

**任务假设与范围**
- 本 PR 仅包含后端变更：模型、数据库迁移、API、导入/导出逻辑、测试与 CI 配置；不包含前端改动。
- 假设当前仓库已含项目骨架、依赖文件与基本测试框架（见 `docs/PROJECT_CONTEXT.md`）。
- 不尝试修复开发环境中尚未实现的包（例如本地 `app` 未完全存在时的测试收集错误）。

**设计与决策**
- 后台批处理：使用任务队列/后台 worker 抽象（轻量接口），只实现任务入队与幂等消费点；允许后续替换底层队列（Redis/RQ/Celery/BackgroundTasks）。
- 账单逻辑：对账单计算添加 `previous_month_arrears` 项并在导出中明示来源与计算日期。
- `Payment` 模型：字段最小化（`id, amount, currency, payer_id, method, status, created_at, metadata`），并在 API 与导入工具中保证幂等性（按外部参考号 dedupe）。
- 数据库迁移：新增 Alembic 版本文件，迁移包含 `payments` 表与必要索引。
- 测试：为关键路径添加单元与集成测试（导入、导出、支付创建、账单计算）。

**代码与文件结构（要点）**
- `app/models/payment.py` — `Payment` SQLModel/SQLAlchemy 模型。
- `app/api/payments.py` — 支付相关路由与校验。
- `app/imports/*` — 导入批处理任务与解析器（CSV / XLSX），以任务入队方式运行。
- `app/billing/export.py` — 导出生成器（CSV/XLSX），支持流式导出以降低内存。
- `alembic/versions/` — 新增迁移文件 `XXXX_add_payment_table.py`。
- `tests/` — 新增/更新的测试文件覆盖上面要点。

**测试与验证**
- 本地：在包含完整项目的 dev 环境中运行 `pytest -q`（注意：若仓库尚未进入某些任务阶段，某些收集错误为预期，不影响本 PR 审核）。
- CI：触发 PR 后，CI 将运行：依赖安装、数据库迁移（sqlite 内存/文件）、运行测试套件、静态分析（如有）。
- 关键验收标准：
  - 支付模型迁移运行成功且无破坏性变更老数据（迁移可回滚）。
  - 导入/导出逻辑在样例数据上通过单元测试。
  - CI 在 PR 上绿灯（测试 + lint）。

**运行与维护**
- 数据库：迁移通过 Alembic 管理；在部署前执行 `alembic upgrade head`。
- 后台任务：文档说明如何配置生产队列（示例使用说明放在 `docs/`）。
- 导出：大型导出推荐异步任务并以临时文件或对象存储交付。

**安全与一致性清单**
- 输入验证：所有导入文件均做行级校验与最大行限制（防止 OOM）。
- 权限控制：支付创建/查看接口遵守现有认证/授权机制。
- 敏感数据：支付元数据应避免将全卡号等敏感信息入库；如需，使用加密/脱敏策略。
- 审计：关键支付事件写入审计日志（或事件表），以便回溯。

**后续迭代建议**
- 将后台任务接入可靠队列（Redis + RQ/Celery）并为任务状态提供观察面板。
- 增加导出分页与断点续传 API，提升大型导出稳定性。
- 引入端到端集成测试（包含真实样例数据与小型 SQLite 实例）。

---

请审阅上述 PR 文本：若满意我可以将其转换为 GitHub PR 描述（或将其提交为仓库文件供审查）。
